<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Gelişmiş 3D Saat Sistemi</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #tooltip {
            position: absolute; background: rgba(0,0,0,0.9); color: #fff;
            padding: 10px; border: 1px solid #444; pointer-events: none; display: none;
            font-family: monospace; z-index: 10;
        }
    </style>
</head>
<body>

<div id="tooltip"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
    // --- VERİTABANI (RENK -> BİLGİ EŞLEŞTİRMESİ) ---
    // Picking Texture üzerindeki renklerin hangi ülkeye ait olduğu
    // Gerçek bir uygulamada bu çok uzun bir JSON listesi olur.
    const countryData = {
        16711680: { name: "Türkiye", offset: 3 },   // Kırmızı (R:255, G:0, B:0) -> Decimal: 16711680
        65280:    { name: "Almanya", offset: 1 },   // Yeşil (R:0, G:255, B:0) -> Decimal: 65280
        255:      { name: "ABD (New York)", offset: -5 }, // Mavi -> Decimal: 255
        // ... Diğer tüm ülkelerin renk kodları buraya ...
    };

    // --- TEMEL KURULUM ---
    const container = document.body;
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 2.5;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);

    // --- 1. GÖRÜNEN SAHNE (Main Scene) ---
    const scene = new THREE.Scene();
    const textureLoader = new THREE.TextureLoader();

    const geometry = new THREE.SphereGeometry(1, 64, 64);
    const material = new THREE.MeshPhongMaterial({
        map: textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'), // Görsel Kaplama
    });
    const earth = new THREE.Mesh(geometry, material);
    scene.add(earth);

    // Işıklar
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 3, 5);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x333333));


    // --- 2. GİZLİ SAHNE (Picking Scene) ---
    // Bu sahne ekrana çizilmez, bellekte tutulur.
    const pickingScene = new THREE.Scene();
    const pickingTarget = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight);
    
    // Picking Texture'ı (Buraya renkli harita yüklenmeli)
    // ÖRNEK İÇİN: Görseli kullanıyoruz ama normalde düz renkli harita olmalı.
    const pickingTexture = textureLoader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'); 
    // NOT: Picking materyalinde ışık/gölge OLMAZ. Sadece düz renk (MeshBasicMaterial) kullanılır.
    const pickingMaterial = new THREE.MeshBasicMaterial({ map: pickingTexture });
    const pickingEarth = new THREE.Mesh(geometry, pickingMaterial);
    pickingScene.add(pickingEarth);


    // --- 3. RENK OKUMA VE ETKİLEŞİM ---
    const tooltip = document.getElementById('tooltip');
    const pixelBuffer = new Uint8Array(4); // R, G, B, A (Tek bir pikseli okuyacağız)

    function pick(event) {
        const x = event.clientX;
        const y = event.clientY;

        // 1. Gizli sahneyi (Picking Scene) render al ama ekrana basma (target'a bas)
        renderer.setRenderTarget(pickingTarget);
        renderer.render(pickingScene, camera);

        // 2. Mouse'un olduğu yerdeki pikselin rengini oku
        // WebGL koordinatları sol-alttan başlar, o yüzden Y'yi ters çeviriyoruz.
        renderer.readRenderTargetPixels(pickingTarget, x, pickingTarget.height - y, 1, 1, pixelBuffer);

        // 3. Normal render işlemine geri dön (Ekrana basılacak görüntü)
        renderer.setRenderTarget(null);

        // 4. Okunan rengi yorumla
        const r = pixelBuffer[0];
        const g = pixelBuffer[1];
        const b = pixelBuffer[2];
        
        // RGB'yi Tekil bir ID numarasına (Hex/Decimal) çevir
        const id = (r << 16) | (g << 8) | (b);

        // 5. Veritabanından kontrol et
        const data = countryData[id];
        
        if (data) {
            // Şehir/Ülke bulunduysa saati hesapla
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const targetTime = new Date(utc + (3600000 * data.offset));
            const timeStr = targetTime.toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'});

            tooltip.style.display = 'block';
            tooltip.style.left = x + 15 + 'px';
            tooltip.style.top = y + 15 + 'px';
            tooltip.innerHTML = `<strong>${data.name}</strong><br>Saat: ${timeStr}`;
            document.body.style.cursor = 'pointer';
        } else {
            // Renk veritabanında yoksa (örn: Okyanus)
            tooltip.style.display = 'none';
            document.body.style.cursor = 'default';
        }
    }

    // --- OPTİMİZASYON ---
    // Her karede piksel okumak yavaştır. Sadece mouse hareket ettiğinde yapalım.
    window.addEventListener('mousemove', pick);

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();

</script>
</body>
</html>
